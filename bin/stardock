#!/usr/bin/env bash
### Usage:
###    stardock
### --help
###
### The primary process to start stardock
export DIR=$(cd $(dirname ${BASH_SOURCE[0]}) && pwd)
source "$DIR/stardock-launcher"

###################################################################
## List of init jobs we should run
###################################################################
INITS=${INITS:-"
  ${DIR}/stardock-init-monitor-repos
"}

###################################################################
## Guards - Don't Move Forward Unless We Should
###################################################################
function punt() {
  echo "$1"
  exit 1
}


###################################################################
## Runs a sub process and keeps track of it
###################################################################
declare -A CHILDREN
function run_daemon() {
  # run daemon
  eval "$1" &
  CHILDREN["$1"]=$!
}

###################################################################
## Let's take care of our children when we die
###################################################################
function kill_children() {
  for init in "${!CHILDREN[@]}"; do
    if [ -e "/proc/${CHILDREN[$init]}" ]; then
      echo "Killing $init ${CHILDREN[$init]}"
      kill "${CHILDREN[$init]}"
      wait "${CHILDREN[$init]}"
    fi
  done
}

trap "{ kill_children; exit 0; }" SIGTERM EXIT

###################################################################
## Setup Any Environment Stuffz
###################################################################
"${DIR}/stardock-install-default-buildpacks"
"${DIR}/stardock-install-docker-network"
"${DIR}/stardock-install-base-container"

###################################################################
## Start Things Off
###################################################################
IFS=$'\n'
for init in $INITS; do
  info "stardock|starting:$1"
  run_daemon "${init}"
done

###################################################################
## Watchdog - Keep Our Inits Running
###################################################################
while [ 1 ]; do
  for init in "${!CHILDREN[@]}"; do
    if [ ! -e "/proc/${CHILDREN[$init]}" ]; then
      warn "stardock|restarting:${init}"
      run_daemon "${init}"
    fi
  done
  sleep "${STARDOCK_PULSE}"
  sleep 10000000000
  # XXX: Delete me
  # echo XXX: DEV EXIT
  # exit 0
done
